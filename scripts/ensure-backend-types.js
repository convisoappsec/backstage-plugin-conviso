#!/usr/bin/env node

/**
 * Script to ensure backend types and entry point are generated after build
 * This creates:
 * 1. dist/backend/index.d.ts (type declarations)
 * 2. backend.js (root entry point for backend import)
 */

const fs = require('fs');
const path = require('path');

const pluginRoot = path.join(__dirname, '..');
const distBackendDir = path.join(pluginRoot, 'dist', 'backend');
const distBackendIndexDts = path.join(distBackendDir, 'index.d.ts');
const distBackendModuleDts = path.join(distBackendDir, 'module.d.ts');
const backendJs = path.join(pluginRoot, 'backend.js');
const distBackendIndexJs = path.join(distBackendDir, 'index.esm.js');

// Create dist/backend directory if it doesn't exist
if (!fs.existsSync(distBackendDir)) {
  fs.mkdirSync(distBackendDir, { recursive: true });
  console.log('üìÅ Created dist/backend directory');
}

// Check if module.d.ts exists (generated by tsc)
if (fs.existsSync(distBackendModuleDts)) {
  // If module.d.ts exists, create index.d.ts that re-exports from module
  // For .d.ts files, TypeScript resolves .d.ts automatically (no extension needed)
  const indexDtsContent = `export { convisoBackendPlugin, convisoBackendPlugin as default } from './module';
`;
  fs.writeFileSync(distBackendIndexDts, indexDtsContent, 'utf8');
  console.log('‚úÖ Created dist/backend/index.d.ts');
} else {
  // If module.d.ts doesn't exist, create a minimal type declaration
  const indexDtsContent = `import type { BackendFeature } from '@backstage/backend-plugin-api';

export const convisoBackendPlugin: BackendFeature;
export default convisoBackendPlugin;
`;
  fs.writeFileSync(distBackendIndexDts, indexDtsContent, 'utf8');
  console.log('‚úÖ Created dist/backend/index.d.ts (minimal types)');
}

// Create backend.js entry point in root
const backendDts = path.join(pluginRoot, 'backend.d.ts');
if (fs.existsSync(distBackendIndexJs)) {
  // Re-export from dist/backend/index.esm.js
  const backendJsContent = `export { convisoBackendPlugin, convisoBackendPlugin as default } from './dist/backend/index.esm.js';
`;
  fs.writeFileSync(backendJs, backendJsContent, 'utf8');
  console.log('‚úÖ Created backend.js entry point');
  
  // Create backend.d.ts for types
  // Point to the .d.ts file for type declarations (TypeScript resolves .d.ts automatically)
  const backendDtsContent = `export { convisoBackendPlugin, convisoBackendPlugin as default } from './dist/backend/index';
`;
  fs.writeFileSync(backendDts, backendDtsContent, 'utf8');
  console.log('‚úÖ Created backend.d.ts type declarations');
} else {
  // Fallback: re-export from src/backend/module directly (avoids cycle)
  // Import from module.ts directly to avoid index.ts re-export cycle
  const backendJsContent = `export { convisoBackendPlugin, convisoBackendPlugin as default } from './src/backend/module.js';
`;
  fs.writeFileSync(backendJs, backendJsContent, 'utf8');
  console.log('‚úÖ Created backend.js entry point (development mode)');
  
  // Create backend.d.ts for types (development)
  // For .d.ts files, TypeScript resolves .ts files automatically (no extension needed)
  const backendDtsContent = `export { convisoBackendPlugin, convisoBackendPlugin as default } from './src/backend/module';
`;
  fs.writeFileSync(backendDts, backendDtsContent, 'utf8');
  console.log('‚úÖ Created backend.d.ts type declarations (development mode)');
}

