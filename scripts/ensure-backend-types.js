#!/usr/bin/env node

/**
 * Script to ensure backend entry point is created after build
 * This creates:
 * 1. dist/backend/index.d.ts (type declarations)
 * 2. backend.js (CommonJS entry point for backend import)
 */

const fs = require('fs');
const path = require('path');

const pluginRoot = path.join(__dirname, '..');
const distBackendDir = path.join(pluginRoot, 'dist', 'backend');
const distBackendIndexDts = path.join(distBackendDir, 'index.d.ts');
const distBackendIndexJs = path.join(distBackendDir, 'index.js');
const distBackendModuleDts = path.join(distBackendDir, 'module.d.ts');
const backendJs = path.join(pluginRoot, 'backend.js');

// Create dist/backend directory if it doesn't exist
if (!fs.existsSync(distBackendDir)) {
  fs.mkdirSync(distBackendDir, { recursive: true });
  console.log('üìÅ Created dist/backend directory');
}

// Check if module.d.ts exists (generated by tsc)
if (fs.existsSync(distBackendModuleDts)) {
  // If module.d.ts exists, create index.d.ts that re-exports from module
  const indexDtsContent = `export { convisoBackendPlugin, convisoBackendPlugin as default } from './module';
`;
  fs.writeFileSync(distBackendIndexDts, indexDtsContent, 'utf8');
  console.log('‚úÖ Created dist/backend/index.d.ts');
} else {
  // If module.d.ts doesn't exist, create a minimal type declaration
  const indexDtsContent = `import type { BackendFeature } from '@backstage/backend-plugin-api';

export const convisoBackendPlugin: BackendFeature;
export default convisoBackendPlugin;
`;
  fs.writeFileSync(distBackendIndexDts, indexDtsContent, 'utf8');
  console.log('‚úÖ Created dist/backend/index.d.ts (minimal types)');
}

// Create backend.js entry point (CommonJS wrapper)
const distBackendModuleJs = path.join(distBackendDir, 'module.js');
if (fs.existsSync(distBackendModuleJs)) {
  // Create index.js that re-exports from module.js
  const indexJsContent = `module.exports = require('./module.js');
`;
  fs.writeFileSync(distBackendIndexJs, indexJsContent, 'utf8');
  console.log('‚úÖ Created dist/backend/index.js');
  
  // Create backend.js entry point in root
  const backendJsContent = `module.exports = require('./dist/backend/index.js');
`;
  fs.writeFileSync(backendJs, backendJsContent, 'utf8');
  console.log('‚úÖ Created backend.js entry point');
} else {
  console.log('‚ö†Ô∏è  Warning: dist/backend/module.js not found. Run build first.');
}